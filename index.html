<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Squilo — SMK MAA'ARIF BANYURESMI (Final v11)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1: #f3fff6;
  --accent: #2e7d32;
  --accent-2: #1b5e20;
  --card: #ffffff;
  --muted: #556b60;
  --glass: rgba(255,255,255,0.8);
  --radius: 12px;
  --shadow: 0 14px 40px rgba(6,20,15,0.06);
  --danger: #e63946;
  --text: #0f1720;
  --input-bg: #f6fff7;
}

/* dark variables */
body.dark-mode{
  --bg1: #071018;
  --accent: #3ddc84;
  --accent-2: #7feac4;
  --card: #0b1220;
  --muted: #9fbfb0;
  --glass: rgba(255,255,255,0.03);
  --shadow: 0 10px 30px rgba(2,6,8,0.8);
  --danger: #ff6b6b;
  --text: #e6f7ea;
  --input-bg: #071722;
}

/* base */
*{box-sizing:border-box;font-family:'Poppins',system-ui,-apple-system,'Segoe UI',Roboto,Arial}
html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),#ffffff);color:var(--text);-webkit-font-smoothing:antialiased}
body.dark-mode{background:linear-gradient(135deg,var(--bg1),#021018)}
.container{max-width:1200px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:white;display:flex;align-items:center;justify-content:center;font-weight:800}
.title{margin:0}
.subtitle{font-size:13px;color:var(--muted)}
/* Landing */
.landing{display:flex;gap:20px;align-items:center;padding:22px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.9),#f9fff9);box-shadow:var(--shadow)}
body.dark-mode .landing{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))}
.l-left{flex:1}
.h1{font-size:22px;margin:0;color:var(--accent-2);font-weight:800}
.tag{color:var(--muted);margin-top:8px}
.btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
.btn-ghost{background:transparent;border:1px solid rgba(30,100,40,0.08);color:var(--accent-2)}
.auth{width:420px;padding:14px;border-radius:12px;background:var(--card);box-shadow:var(--shadow)}
.auth input, .auth select{background:var(--input-bg);border:1px solid rgba(0,0,0,0.04);color:var(--text)}
.small{font-size:13px;color:var(--muted)}
.hint{font-size:12px;color:#2d6b47}
.typing{display:inline-block;border-right:2px solid var(--accent-2);padding-right:6px;animation:caret 1s steps(1) infinite}
@keyframes caret{50%{border-color:transparent}}
/* App */
.app-wrap{display:grid;grid-template-columns:260px 1fr;gap:16px;margin-top:18px}
.sidebar{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);height:calc(100vh - 120px);position:sticky;top:18px;overflow:auto}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.nav button{background:transparent;border:0;padding:10px;border-radius:8px;text-align:left;cursor:pointer;font-weight:700;color:var(--accent-2)}
.nav button:hover{background:rgba(30,100,40,0.06)}
.badge{padding:6px 8px;border-radius:8px;background:#e6fbeb;color:var(--accent-2);font-weight:700}
.page{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);min-height:64vh;overflow:auto}
.kpi{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.kpi .box{min-width:140px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f7fffa);box-shadow:0 6px 18px rgba(0,0,0,0.02)}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{border-bottom:1px solid #eefaf0;padding:8px;text-align:left}
body.dark-mode .table th,.table td{border-bottom:1px solid rgba(255,255,255,0.03)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.footer{margin-top:12px;text-align:center;color:var(--muted)}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow);margin-top:12px}
.hidden{display:none}
.flex{display:flex;gap:8px;align-items:center}
.avatar{width:40px;height:40px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
.search{display:flex;gap:8px;align-items:center}
.status-present{background:#e8f5e9;padding:6px;border-radius:6px;color:var(--accent-2);font-weight:700}
.status-absent{background:#fff3e0;padding:6px;border-radius:6px;color:#ef6c00;font-weight:700}
.status-permit{background:#e3f2fd;padding:6px;border-radius:6px;color:#0277bd;font-weight:700}
.note{font-size:13px;color:var(--muted)}
.switch{display:inline-flex;align-items:center;gap:8px}
.dark-mode{background:#0f1720;color:#e6f7ea}
@media(max-width:980px){.app-wrap{grid-template-columns:1fr}.sidebar{position:static;height:auto}}

/* inputs & small buttons */
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);margin-top:8px;background:var(--input-bg);color:var(--text)}
.btn-sm{padding:6px 8px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
.btn-danger{background:var(--danger);color:#fff}

/* ensure contrast in dark mode */
body.dark-mode .btn-ghost{border-color:rgba(255,255,255,0.06);color:var(--text)}
body.dark-mode .btn-primary{box-shadow:0 6px 14px rgba(0,0,0,0.5)}

/* small helpers */
.meta{font-size:12px;color:var(--muted);margin-top:6px}

/* file preview small */
.file-preview{font-size:13px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo">MAA</div>
        <div>
          <h1 class="title">SMK MAA'ARIF BANYURESMI — Squilo</h1>
          <div class="subtitle">Absensi • Nilai (per mapel & tugas) • SPP • PPDB • Tugas</div>
        </div>
      </div>
      <div style="text-align:right">
        <div id="topUser" class="small">Guest</div>
        <div id="topMotiv" class="small">“Belajar bukan tentang siapa yang paling cepat, tapi siapa yang paling sabar memahami.”</div>
      </div>
    </header>

    <!-- Landing -->
    <section id="landing" class="landing">
      <div class="l-left">
        <h2 class="h1">Welcome to <span class="typing">SMK MAA'ARIF BANYURESMI</span></h2>
        <div class="tag small">Sistem sekolah lengkap — offline, satu file. Upload ke static.app lalu jalankan.</div>
        <div style="margin-top:12px" class="forms">
          <button id="btnShowLogin" class="btn btn-primary">Login</button>
          <button id="btnShowRegister" class="btn btn-ghost">Register</button>
        </div>
      </div>

      <div class="auth">
        <!-- Login -->
        <div id="panelLogin">
          <h3 style="margin:0;color:var(--accent-2)">Masuk</h3>
          <div class="small" style="margin-top:6px">Masukkan username & password Anda.</div>
          <input id="login_username" class="input" placeholder="Username (NIS / email)"/>
          <input id="login_password" class="input" placeholder="Password" type="password"/>
          <div style="margin-top:10px" class="controls">
            <button id="btnLogin" class="btn btn-primary">Masuk</button>
            <button id="btnToRegister" class="btn btn-ghost">Daftar</button>
          </div>
          <div class="hint" style="margin-top:10px">Akun admin: <i>disimpan di DB</i> (tidak tampil di UI publik).</div>
        </div>

        <!-- Register -->
        <div id="panelRegister" class="hidden">
          <h3 style="margin:0;color:var(--accent-2)">Daftar Akun</h3>
          <div class="small" style="margin-top:6px">Buat akun baru (data disimpan lokal).</div>
          <input id="reg_username" class="input" placeholder="Username (NIS / email)"/>
          <input id="reg_name" class="input" placeholder="Nama lengkap"/>
          <input id="reg_password" class="input" placeholder="Password" type="password"/>
          <select id="reg_role" class="input" style="margin-top:8px">
            <option value="siswa">Siswa</option>
            <option value="guru">Guru</option>
          </select>
          <select id="reg_class" class="input" style="margin-top:8px"></select>
          <div style="margin-top:10px" class="controls">
            <button id="btnRegister" class="btn btn-primary">Daftar</button>
            <button id="btnToLogin" class="btn btn-ghost">Kembali</button>
          </div>
        </div>
      </div>
    </section>

    <!-- App -->
    <div id="app" class="app-wrap hidden">
      <aside class="sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="menuGreeting" style="font-weight:800">Halo</div>
            <div id="menuRole" class="small">Role</div>
          </div>
          <div id="avatar" class="avatar">U</div>
        </div>

        <nav id="nav" class="nav"></nav>

        <div id="adminTools" style="margin-top:12px;display:none">
          <hr/>
          <div class="small">Admin Tools</div>
          <div style="margin-top:8px" class="controls">
            <button id="btnImport" class="btn btn-ghost">Import JSON</button>
            <button id="btnExport" class="btn btn-ghost">Export JSON</button>
            <button id="btnExportWord" class="btn btn-primary">Simpan → Word (.doc)</button>
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;flex-direction:column">
          <div class="switch"><label class="small">Mode Gelap</label><button id="btnToggleMode" class="btn btn-ghost">Toggle Dark</button></div>
          <button id="btnLogout" class="btn btn-ghost" style="background:#fff;color:var(--accent-2);border:1px solid rgba(46,125,50,0.08)">Logout</button>
        </div>
      </aside>

      <main id="main" class="page">
        <div id="content">
          <h3>Selamat datang</h3>
          <div class="small">Pilih menu di sidebar untuk mulai mengelola.</div>
          <div class="kpi">
            <div class="box"><div class="small">Jumlah Kelas</div><div id="kpiClasses" style="font-weight:700">0</div></div>
            <div class="box"><div class="small">Jumlah Siswa</div><div id="kpiStudents" style="font-weight:700">0</div></div>
            <div class="box"><div class="small">Absensi Hari Ini</div><div id="kpiToday" style="font-weight:700">0</div></div>
          </div>
        </div>
      </main>
    </div>

    <div class="footer small">© 2025 SMK MAA'ARIF BANYURESMI — Squilo</div>
  </div>

<script>
/* Squilo Final v11 - single-file complete (tugas + pengumpulan)
   - localStorage key: squilo_final_v10 (backwards compat)
   - Tugas:
     db.tugas = [{id, title, desc, deadline, classId, createdBy, createdAt, submissions: [{id, studentId, nis, name, note, link, file: {name, type, base64}, submittedAt, score, gradedBy, gradedAt}]}]
   - File uploads use base64 (BE CAUTIOUS with big files)
*/

const KEY = 'squilo_final_v10';
let db = {
  users: [],
  classes: [],
  applicants: [],
  spp: [],
  tugas: [] // new: tasks
};
let currentUser = null;

function saveDB(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function loadDB(){ const raw = localStorage.getItem(KEY); if(raw) db = JSON.parse(raw); }

/* Helper uid */
function uid(prefix='id'){ return prefix + Date.now() + Math.floor(Math.random()*999); }

/* Seed default */
function seed(){
  loadDB();
  if(db.users && db.users.length) {
    if(!db.tugas) db.tugas = [];
    return;
  }
  db.users = [
    {id:'u_admin', username:'admin', name:'Administrator', pass:'operatorsmkmb', role:'admin'},
    {id:'u_guru', username:'guru', name:'Ibu Guru', pass:'guru', role:'guru'},
    {id:'u_siswa', username:'siswa', name:'Siswi Demo', pass:'siswa', role:'siswa', studentId:'S001'}
  ];
  db.classes = [
    {id:'c10tkj1', name:'10 TKJ 1', level:10, subjects:['Matematika','Bahasa Indonesia','Produktif TKJ'], students:[
      {id:'S001', nis:'S001', name:'Siswi Demo', attendance:[], grades:[]},
      {id:'S002', nis:'S002', name:'Andi Saputra', attendance:[], grades:[]}
    ]},
    {id:'c11tkj1', name:'11 TKJ 1', level:11, subjects:['Matematika','Bahasa Inggris','Produktif TKJ'], students:[
      {id:'S003', nis:'S003', name:'Budi Santoso', attendance:[], grades:[]}
    ]},
    {id:'c12tkj1', name:'12 TKJ 1', level:12, subjects:['Produktif TKJ','Sistem Digital'], students:[]},
    {id:'c12tkj2', name:'12 TKJ 2', level:12, subjects:['Produktif TKJ','Kewirausahaan'], students:[]}
  ];
  db.applicants = [];
  db.spp = [];
  db.tugas = []; // start empty
  saveDB();
}
seed();

/* ---------------- DOM refs ---------------- */
const landing = document.getElementById('landing');
const panelLogin = document.getElementById('panelLogin');
const panelRegister = document.getElementById('panelRegister');
const btnShowLogin = document.getElementById('btnShowLogin');
const btnShowRegister = document.getElementById('btnShowRegister');
const btnToRegister = document.getElementById('btnToRegister');
const btnToLogin = document.getElementById('btnToLogin');
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');
const regClass = document.getElementById('reg_class');

const app = document.getElementById('app');
const nav = document.getElementById('nav');
const adminTools = document.getElementById('adminTools');
const menuGreeting = document.getElementById('menuGreeting');
const menuRole = document.getElementById('menuRole');
const avatar = document.getElementById('avatar');
const topUser = document.getElementById('topUser');
const content = document.getElementById('content');
const kpiClasses = document.getElementById('kpiClasses');
const kpiStudents = document.getElementById('kpiStudents');
const kpiToday = document.getElementById('kpiToday');

const btnLogout = document.getElementById('btnLogout');
const btnImport = document.getElementById('btnImport');
const btnExport = document.getElementById('btnExport');
const btnExportWord = document.getElementById('btnExportWord');
const btnToggleMode = document.getElementById('btnToggleMode');

const loginUser = document.getElementById('login_username');
const loginPass = document.getElementById('login_password');
const regUser = document.getElementById('reg_username');
const regName = document.getElementById('reg_name');
const regPass = document.getElementById('reg_password');
const regRole = document.getElementById('reg_role');

/* ---------------- Helpers ---------------- */
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function findClassById(id){ return db.classes.find(c=>c.id===id); }
function findStudentById(sid){ for(const c of db.classes){ const s = c.students.find(x=>x.id===sid); if(s) return s; } return null; }
function updateTop(){ topUser.innerText = currentUser ? `${currentUser.name} (${currentUser.role})` : 'Guest'; menuGreeting.innerText = currentUser ? `Halo, ${currentUser.name}` : 'Halo'; menuRole.innerText = currentUser ? currentUser.role : ''; avatar.innerText = currentUser ? (currentUser.name.split(' ').map(w=>w[0]).slice(0,2).join('')) : 'U'; }
function refreshKPIs(){
  kpiClasses.innerText = db.classes.length;
  kpiStudents.innerText = db.classes.reduce((a,c)=>a + (c.students?c.students.length:0), 0);
  const today = new Date().toISOString().slice(0,10);
  const todayCount = db.classes.reduce((a,c)=> a + c.students.reduce((s,st)=> s + st.attendance.filter(x=>x.date===today).length,0),0);
  kpiToday.innerText = todayCount;
}

/* ---------------- Landing events ---------------- */
btnShowLogin.onclick = ()=> { showLoginPanel(); };
btnShowRegister.onclick = ()=> { showRegisterPanel(); };
btnToRegister.onclick = ()=> showRegisterPanel();
btnToLogin.onclick = ()=> showLoginPanel();

function showLoginPanel(){ show(panelLogin); hide(panelRegister); populateRegClass(); }
function showRegisterPanel(){ show(panelRegister); hide(panelLogin); populateRegClass(); }

/* populate register class */
function populateRegClass(){
  regClass.innerHTML = '';
  db.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; regClass.appendChild(o); });
}

/* ---------------- Auth logic ---------------- */
btnLogin.addEventListener('click', ()=> {
  const u = loginUser.value.trim(), p = loginPass.value;
  if(!u||!p){ alert('Isi username & password'); return; }
  const user = db.users.find(x=>x.username===u);
  if(!user || user.pass !== p){ alert('Login gagal — periksa username/password'); return; }
  currentUser = user;
  if(currentUser.role === 'siswa' && !currentUser.studentId){
    for(const c of db.classes){ const st = c.students.find(s=>s.nis === currentUser.username); if(st){ currentUser.studentId = st.id; break; } }
  }
  enterApp();
});

btnRegister.addEventListener('click', ()=> {
  const username = regUser.value.trim(), name = regName.value.trim(), pass = regPass.value, role = regRole.value, classId = regClass.value;
  if(!username || !name || !pass){ alert('Lengkapi data register'); return; }
  if(db.users.some(x=>x.username===username)){ alert('Username sudah dipakai'); return; }
  const newUser = {id:uid('u'), username, name, pass, role};
  if(role === 'siswa'){
    const sid = uid('S'); newUser.studentId = sid;
    const cls = findClassById(classId) || db.classes[0];
    cls.students.push({id:sid, nis:username, name, attendance:[], grades:[]});
  }
  db.users.push(newUser); saveDB();
  alert('Registrasi sukses, silakan login'); regUser.value=''; regName.value=''; regPass.value=''; showLoginPanel();
});

/* ---------------- Enter App ---------------- */
function enterApp(){
  hide(landing); show(app);
  updateTop(); refreshKPIs();
  buildNav();
  renderDashboard();
  adminTools.style.display = currentUser.role==='admin' ? 'block' : 'none';
  loginUser.value=''; loginPass.value='';
}

/* logout */
btnLogout.addEventListener('click', ()=> {
  if(!confirm('Yakin logout?')) return;
  currentUser = null;
  hide(app); show(landing);
  showLoginPanel();
  updateTop();
});

/* ---------------- Build Navigation ---------------- */
function buildNav(){
  nav.innerHTML = '';
  function add(label, fn, roles=['admin','guru','siswa']){
    if(!roles.includes(currentUser.role)) return;
    const b = document.createElement('button'); b.innerText = label; b.onclick = fn; nav.appendChild(b);
  }
  add('Dashboard', renderDashboard, ['admin','guru','siswa']);
  add('Kelas & Siswa', renderClasses, ['admin','guru']);
  add('Absensi & Nilai', renderAttendance, ['admin','guru']);
  add('Data Siswa (Per Kelas)', renderDataStudents, ['admin','guru']);
  add('SPP (Pembayaran)', renderSPP, ['admin','guru','siswa']);
  add('Tugas', renderTasks, ['admin','guru','siswa']);
  add('PPDB (Calon)', renderPPDB, ['admin']);
  add('Semua Data', renderAllData, ['admin']);
  add('Pengguna', renderUsers, ['admin']);
  add('Ubah Password', renderChangePassword, ['admin','guru','siswa']);
}

/* ---------------- Dashboard ---------------- */
function renderDashboard(){
  const html = `<h3>Dashboard</h3><div class="small">Ringkasan singkat</div>
    <div class="kpi">
      <div class="box"><div class="small">Jumlah Kelas</div><div style="font-weight:700">${db.classes.length}</div></div>
      <div class="box"><div class="small">Jumlah Siswa</div><div style="font-weight:700">${db.classes.reduce((a,c)=>a + (c.students?c.students.length:0),0)}</div></div>
      <div class="box"><div class="small">Absensi Hari Ini</div><div style="font-weight:700">${db.classes.reduce((a,c)=> a + c.students.reduce((s,st)=> s + st.attendance.filter(x=>x.date===new Date().toISOString().slice(0,10)).length,0),0)}</div></div>
    </div>
    <div class="card"><div class="small">Selamat datang, ${currentUser.name}. Gunakan menu di samping untuk mengelola data.</div></div>`;
  content.innerHTML = html;
  refreshKPIs();
}

/* ---------------- Classes & Students ---------------- */
function renderClasses(){
  if(!['admin','guru'].includes(currentUser.role)) return alert('Akses ditolak');
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>Kelas & Siswa</h3>`;
  if(currentUser.role==='admin') html += `<div class="controls"><input id="newClassName" class="input" placeholder="Nama kelas (contoh: 10 TKJ 1)" style="width:320px"/><button id="addClass" class="btn btn-primary">Tambah Kelas</button></div>`;
  html += `</div><div id="classesList" class="card"></div>`;
  content.innerHTML = html;

  function draw(){
    const container = document.getElementById('classesList'); container.innerHTML = '';
    db.classes.forEach((c, idx) => {
      const div = document.createElement('div'); div.className='card'; div.style.marginBottom='10px';
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${c.name}</strong><div class="small">Level ${c.level} • ${c.students.length} siswa</div><div class="meta">Mapel: ${c.subjects ? c.subjects.join(', ') : '-'}</div></div><div class="controls">
        <button data-idx="${idx}" class="viewClass btn btn-ghost">Buka</button>
        ${currentUser.role==='admin'?`<button data-idx="${idx}" class="editClass btn btn-ghost">Edit</button><button data-idx="${idx}" class="delClass btn btn-ghost">Hapus</button>`:''}
        </div></div>
        <div style="margin-top:8px"><button data-idx="${idx}" class="addStd btn btn-primary">+ Tambah Murid</button> <button data-idx="${idx}" class="manageSubs btn btn-ghost">Kelola Mapel</button></div>
        <div style="margin-top:8px" class="small">Daftar siswa:</div>
        <ul>${c.students.map(s=>`<li>${s.nis} — ${s.name} ${currentUser.role==='admin'?`<button data-sid="${s.id}" data-cidx="${idx}" class="delStd btn btn-ghost">Hapus</button>`:''}</li>`).join('')}</ul>`;
      container.appendChild(div);
    });
  }
  draw();

  if(currentUser.role==='admin'){
    document.getElementById('addClass').addEventListener('click', ()=> {
      const name = document.getElementById('newClassName').value.trim(); if(!name){ alert('Masukkan nama kelas'); return; }
      const level = parseInt(name) || 10;
      db.classes.push({id:uid('C'), name, level, subjects:[], students:[]}); saveDB(); document.getElementById('newClassName').value=''; draw(); refreshKPIs();
    });
    document.getElementById('classesList').addEventListener('click',(e)=> {
      if(e.target.classList.contains('editClass')){ const idx = e.target.dataset.idx; const c = db.classes[idx]; const nn = prompt('Ubah nama kelas:', c.name); if(nn){ c.name = nn; saveDB(); draw(); } }
      if(e.target.classList.contains('delClass')){ const idx = e.target.dataset.idx; if(!confirm('Hapus kelas?')) return; db.classes.splice(idx,1); saveDB(); draw(); refreshKPIs(); }
      if(e.target.classList.contains('addStd')){ const idx = e.target.dataset.idx; const name = prompt('Nama murid:'); const nis = prompt('NIS / ID siswa:'); if(name && nis){ const sid = uid('S'); db.classes[idx].students.push({id:sid, nis, name, attendance:[], grades:[]}); saveDB(); draw(); refreshKPIs(); } }
      if(e.target.classList.contains('delStd')){ const sid = e.target.dataset.sid; const cidx = e.target.dataset.cidx; if(!confirm('Hapus siswa?')) return; db.classes[cidx].students = db.classes[cidx].students.filter(x=>x.id!==sid); saveDB(); draw(); refreshKPIs(); }
      if(e.target.classList.contains('viewClass')) renderClassDetail(e.target.dataset.idx);
      if(e.target.classList.contains('manageSubs')) manageSubjects(e.target.dataset.idx);
    });
  } else {
    document.getElementById('classesList').addEventListener('click',(e)=> {
      if(e.target.classList.contains('addStd')){ const idx = e.target.dataset.idx; const name = prompt('Nama murid:'); const nis = prompt('NIS / ID siswa:'); if(name && nis){ const sid = uid('S'); db.classes[idx].students.push({id:sid, nis, name, attendance:[], grades:[]}); saveDB(); draw(); refreshKPIs(); } }
      if(e.target.classList.contains('viewClass')) renderClassDetail(e.target.dataset.idx);
      if(e.target.classList.contains('manageSubs')) manageSubjects(e.target.dataset.idx);
    });
  }

  function manageSubjects(idx){
    const c = db.classes[idx];
    const subs = prompt('Mapel dipisah koma. Saat ini: ' + (c.subjects?c.subjects.join(', '):'') + '\nContoh: Matematika, Bahasa Indonesia, Produktif TKJ', c.subjects ? c.subjects.join(', ') : '');
    if(subs !== null){
      c.subjects = subs.split(',').map(s=>s.trim()).filter(Boolean);
      saveDB(); draw();
    }
  }
}

function renderClassDetail(idx){
  const c = db.classes[idx];
  content.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>${c.name}</h3><div class="controls"><button id="backClasses" class="btn btn-ghost">Kembali</button></div></div>
    <div style="margin-top:12px"><table class="table"><thead><tr><th>NIS</th><th>Nama</th><th>Absensi (count)</th><th>Nilai (count)</th><th>Aksi</th></tr></thead><tbody>${c.students.map(s=>`<tr><td>${s.nis}</td><td>${s.name}</td><td>${s.attendance.length}</td><td>${s.grades.length}</td><td>${currentUser.role==='admin'?`<button data-sid="${s.id}" data-cid="${c.id}" class="editStd btn btn-ghost">Edit</button> <button data-sid="${s.id}" data-cid="${c.id}" class="delStd btn btn-ghost">Hapus</button>`:'-'}</td></tr>`).join('')}</tbody></table></div>`;
  document.getElementById('backClasses').addEventListener('click', ()=> renderClasses());
  content.addEventListener('click', function handler(e){
    if(e.target.classList.contains('editStd')){
      const sid = e.target.dataset.sid, cid = e.target.dataset.cid; const cls = findClassById(cid); const s = cls.students.find(x=>x.id===sid); const nn = prompt('Nama baru:', s.name); if(nn){ s.name = nn; saveDB(); renderClassDetail(db.classes.indexOf(cls)); }
    }
    if(e.target.classList.contains('delStd')){
      if(!confirm('Hapus siswa?')) return; const sid = e.target.dataset.sid, cid = e.target.dataset.cid; const cls = findClassById(cid); cls.students = cls.students.filter(x=>x.id!==sid); saveDB(); renderClassDetail(db.classes.indexOf(cls)); refreshKPIs();
    }
  });
}

/* ---------------- Attendance & Grades (per class, per subject, per assignment) ---------------- */
function renderAttendance(){
  if(!['admin','guru'].includes(currentUser.role)) return alert('Akses ditolak');
  content.innerHTML = `<h3>Absensi & Nilai</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <select id="attClass" class="input"></select>
      <select id="attSubject" class="input"></select>
      <input id="attAssignment" class="input" placeholder="Jenis/Tugas (contoh: UTS, Tugas1)" style="width:180px"/>
      <input type="date" id="attDate" class="input" value="${new Date().toISOString().slice(0,10)}" style="width:180px"/>
      <button id="btnRefresh" class="btn btn-ghost">Refresh</button>
    </div>
    <div id="attArea" class="card"></div>`;
  const sel = document.getElementById('attClass');
  db.classes.forEach(c=> sel.appendChild(Object.assign(document.createElement('option'),{value:c.id,textContent:c.name})));
  sel.onchange = populateSubjects;
  document.getElementById('btnRefresh').onclick = draw;
  populateSubjects();
  draw();

  function populateSubjects(){
    const selSub = document.getElementById('attSubject');
    selSub.innerHTML = '';
    const cls = findClassById(document.getElementById('attClass').value || db.classes[0].id);
    (cls.subjects || []).forEach(s => selSub.appendChild(Object.assign(document.createElement('option'),{value:s,textContent:s})));
    if(!selSub.options.length){
      selSub.appendChild(Object.assign(document.createElement('option'),{value:'',textContent:'(tidak ada mapel)'}));
    }
    draw();
  }

  function draw(){
    const classId = document.getElementById('attClass').value || db.classes[0].id;
    const subject = document.getElementById('attSubject').value || '';
    const assignment = document.getElementById('attAssignment').value.trim() || 'Umum';
    const date = document.getElementById('attDate').value;
    const cls = findClassById(classId);
    const area = document.getElementById('attArea'); area.innerHTML = '';
    if(!cls) return area.innerHTML = '<div class="small">Tidak ada kelas</div>';
    let html = `<table class="table"><thead><tr><th>NIS</th><th>Nama</th><th>Absen (${date})</th><th>Nilai (${subject} • ${assignment})</th><th>Aksi</th></tr></thead><tbody>`;
    cls.students.forEach(s=>{
      const rec = s.attendance.find(a=>a.date===date) || {};
      const status = rec.status || 'none';
      const gradeRec = s.grades.find(g=> g.date===date && g.subject===subject && g.assignment===assignment) || {};
      const grade = gradeRec.value !== undefined ? gradeRec.value : '';
      html += `<tr data-sid="${s.id}"><td>${s.nis}</td><td>${s.name}</td>
        <td>
          <select class="selStatus">
            <option value="present" ${status==='present'?'selected':''}>Hadir</option>
            <option value="permit" ${status==='permit'?'selected':''}>Izin</option>
            <option value="absent" ${status==='absent'?'selected':''}>Alfa</option>
            <option value="none" ${status==='none'?'selected':''}>-</option>
          </select>
        </td>
        <td><input class="input input-grade" style="width:120px" value="${grade}"/></td>
        <td><button class="btn btn-primary saveRow">Simpan</button></td></tr>`;
    });
    html += `</tbody></table><div style="margin-top:10px" class="small">Data disimpan ke storage saat tombol "Simpan" ditekan. Nilai disimpan per mapel & jenis/tugas.</div>`;
    area.innerHTML = html;

    area.querySelectorAll('.saveRow').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const tr = ev.target.closest('tr'); const sid = tr.dataset.sid;
        const status = tr.querySelector('.selStatus').value;
        const gradeVal = tr.querySelector('.input-grade').value.trim();
        const student = cls.students.find(x=>x.id===sid);
        student.attendance = student.attendance.filter(a=> a.date !== date);
        if(status !== 'none') student.attendance.push({date, status, by: currentUser.username, at: new Date().toISOString()});
        student.grades = student.grades.filter(g=> !(g.date===date && g.subject===subject && g.assignment===assignment));
        if(gradeVal !== '') student.grades.push({date, subject, assignment, value: gradeVal, by: currentUser.username, at: new Date().toISOString()});
        saveDB(); alert(`Tersimpan: ${student.name}`); refreshKPIs();
      });
    });
  }
}

/* ---------------- Tasks (Tugas & Pengumpulan) ---------------- */
function renderTasks(){
  // Everyone can view tasks; only admin/guru can create/grade
  content.innerHTML = `<h3>Tugas & Pengumpulan</h3>
    <div class="card">
      ${(['admin','guru'].includes(currentUser.role)) ? `
      <h4>Buat Tugas Baru</h4>
      <input id="t_title" class="input" placeholder="Judul tugas (contoh: Tugas Praktikum 1)"/>
      <textarea id="t_desc" class="input" placeholder="Deskripsi tugas" rows="3" style="resize:vertical"></textarea>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="t_class" class="input"></select>
        <input id="t_deadline" type="date" class="input" />
        <button id="t_create" class="btn btn-primary">Buat Tugas</button>
      </div>
      <div class="meta">Catatan: file yang diupload disimpan di browser (base64). Hindari file besar.</div>
      <hr/>` : `<div class="small">Daftar tugas untuk kelas Anda. Klik tugas untuk melihat detail & mengumpulkan.</div>`}
      <div style="margin-top:8px"><input id="t_search" class="input" placeholder="Cari judul tugas..." /></div>
    </div>
    <div id="t_list" class="card" style="margin-top:12px"></div>`;

  // populate class select
  const sel = document.getElementById('t_class');
  sel.innerHTML = '';
  db.classes.forEach(c=> sel.appendChild(Object.assign(document.createElement('option'),{value:c.id,textContent:c.name})));
  if(!sel.options.length) sel.appendChild(Object.assign(document.createElement('option'),{value:'',textContent:'(tidak ada kelas)'}));
  if(['admin','guru'].includes(currentUser.role)){
    document.getElementById('t_create').addEventListener('click', ()=>{
      const title = document.getElementById('t_title').value.trim();
      const desc = document.getElementById('t_desc').value.trim();
      const classId = document.getElementById('t_class').value;
      const deadline = document.getElementById('t_deadline').value;
      if(!title || !classId){ alert('Judul & kelas wajib'); return; }
      const t = {id:uid('T'), title, desc, deadline, classId, createdBy: currentUser.username, createdAt: new Date().toISOString(), submissions: []};
      db.tugas.push(t); saveDB(); document.getElementById('t_title').value=''; document.getElementById('t_desc').value=''; renderTaskList();
    });
  }

  document.getElementById('t_search').addEventListener('input', renderTaskList);
  renderTaskList();

  function renderTaskList(){
    const q = document.getElementById('t_search').value.trim().toLowerCase();
    const list = document.getElementById('t_list'); list.innerHTML = '';
    const rows = db.tugas.filter(t=> !q || t.title.toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q));
    if(rows.length===0) list.innerHTML = '<div class="small">Belum ada tugas.</div>';
    rows.forEach(t=>{
      // only show tasks for student's class (if siswa)
      if(currentUser.role==='siswa'){
        const st = findStudentById(currentUser.studentId);
        const cls = db.classes.find(c=>c.id===t.classId);
        if(!cls || !cls.students.find(s=>s.id===currentUser.studentId)) return; // skip not for this student
      }
      const cls = findClassById(t.classId);
      const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px';
      const due = t.deadline ? ` • Tenggat: ${t.deadline}` : '';
      d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${t.title}</strong><div class="small">${cls?cls.name:'-'}${due}</div><div class="meta">${t.desc||''}</div></div><div class="controls"><button data-id="${t.id}" class="viewTask btn btn-primary">Buka</button> ${(currentUser.role==='admin'||currentUser.role==='guru')?`<button data-id="${t.id}" class="delTask btn btn-ghost">Hapus</button>`:''}</div></div>`;
      list.appendChild(d);
    });

    list.addEventListener('click', (e)=>{
      if(e.target.classList.contains('viewTask')) renderTaskDetail(e.target.dataset.id);
      if(e.target.classList.contains('delTask')){ if(!confirm('Hapus tugas?')) return; db.tugas = db.tugas.filter(x=>x.id!==e.target.dataset.id); saveDB(); renderTaskList(); }
    });
  }
}

/* render single task detail and submissions */
function renderTaskDetail(taskId){
  const t = db.tugas.find(x=>x.id===taskId);
  if(!t) return alert('Tugas tidak ditemukan');
  const cls = findClassById(t.classId);
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>${t.title}</h3><div class="controls"><button id="backTasks" class="btn btn-ghost">Kembali</button></div></div>
    <div class="card"><div class="small">${cls?cls.name:'-'} • Dibuat oleh: ${t.createdBy} • ${new Date(t.createdAt).toLocaleString()}</div><div style="margin-top:8px">${t.desc||'<i>Tidak ada deskripsi</i>'}</div>${t.deadline?`<div class="meta">Tenggat: ${t.deadline}</div>`:''}</div>`;

  // if student -> show submission form
  if(currentUser.role === 'siswa'){
    // check if already submitted
    const existing = t.submissions.find(s=>s.studentId === currentUser.studentId);
    if(existing){
      html += `<div class="card"><h4>Pengumpulan Anda</h4>
        <div class="small">Tanggal: ${new Date(existing.submittedAt).toLocaleString()}</div>
        <div class="meta">Catatan: ${existing.note||'-'}</div>
        <div class="meta">Link: ${existing.link?`<a href="${existing.link}" target="_blank">${existing.link}</a>`:'-'}</div>
        <div class="meta">File: ${existing.file?`<span class="file-preview">${existing.file.name} (${existing.file.type})</span> <button id="download_sub_file" class="btn btn-ghost">Unduh</button>`:'-'}</div>
        <div class="meta">Nilai: ${existing.score !== undefined ? existing.score : '<i>Belum dinilai</i>'}</div>
        <div style="margin-top:8px"><button id="re_submit" class="btn btn-ghost">Kirim Ulang / Edit</button></div>
      </div>`;
    } else {
      html += `<div class="card"><h4>Submit Tugas</h4>
        <input id="sub_link" class="input" placeholder="Link (opsional, mis. Drive)"/>
        <textarea id="sub_note" class="input" placeholder="Catatan / jawaban singkat (opsional)" rows="3" style="resize:vertical"></textarea>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="sub_file" type="file" class="input" />
          <button id="sub_do" class="btn btn-primary">Kirim</button>
        </div>
        <div class="meta">File akan disimpan di browser (base64). Hindari file > 2MB.</div>
      </div>`;
    }
  }

  // show submissions list (for teacher/admin) and allow grading
  html += `<div class="card"><h4>Pengumpulan (${t.submissions.length})</h4>`;
  if(t.submissions.length===0) html += `<div class="small">Belum ada pengumpulan.</div>`;
  else {
    html += `<table class="table"><thead><tr><th>NIS</th><th>Nama</th><th>Catatan</th><th>Link/File</th><th>Waktu</th><th>Nilai</th><th>Aksi</th></tr></thead><tbody>`;
    t.submissions.forEach(sub=>{
      const st = findStudentById(sub.studentId);
      const fileCell = sub.file ? `<span class="file-preview">${sub.file.name}</span> <button data-id="${sub.id}" class="dlFile btn btn-ghost">Unduh</button>` : '-';
      html += `<tr data-subid="${sub.id}"><td>${sub.nis}</td><td>${sub.name}</td><td>${sub.note||'-'}</td><td>${sub.link?`<a href="${sub.link}" target="_blank">Link</a>`:'-'} ${fileCell}</td><td>${new Date(sub.submittedAt).toLocaleString()}</td><td>${sub.score !== undefined ? sub.score : '-'}</td><td>${(['admin','guru'].includes(currentUser.role))?`<input class="input grade-input" style="width:100px" value="${sub.score !== undefined ? sub.score : ''}"/> <button class="btn btn-primary save-grade">Simpan</button>`:'-'}</td></tr>`;
    });
    html += `</tbody></table>`;
  }
  html += `</div>`;

  content.innerHTML = html;

  document.getElementById('backTasks').addEventListener('click', ()=> renderTasks());

  // student actions
  if(currentUser.role === 'siswa'){
    const existing = t.submissions.find(s=>s.studentId === currentUser.studentId);
    if(existing){
      const btnDl = document.getElementById('download_sub_file');
      if(btnDl){
        btnDl.addEventListener('click', ()=> {
          if(!existing.file || !existing.file.base64) return alert('Tidak ada file');
          downloadBase64File(existing.file.base64, existing.file.name, existing.file.type);
        });
      }
      const re = document.getElementById('re_submit');
      re.addEventListener('click', ()=> {
        // allow edit: remove existing then show submission form by re-rendering (simple approach)
        t.submissions = t.submissions.filter(s=>s.studentId !== currentUser.studentId); saveDB(); renderTaskDetail(taskId);
      });
    } else {
      document.getElementById('sub_do').addEventListener('click', async ()=>{
        const link = document.getElementById('sub_link').value.trim();
        const note = document.getElementById('sub_note').value.trim();
        const fileInp = document.getElementById('sub_file');
        let fileObj = null;
        if(fileInp.files && fileInp.files[0]){
          const f = fileInp.files[0];
          if(f.size > 2_500_000){ if(!confirm('File >2.5MB — ingin tetap mengupload? Bisa membuat storage berat. Lanjutkan?')===true){ /* continue */ } }
          try{
            const base64 = await fileToBase64(f);
            fileObj = {name: f.name, type: f.type || 'application/octet-stream', base64};
          } catch(err){ alert('Gagal membaca file'); return; }
        }
        const st = findStudentById(currentUser.studentId);
        const sub = {id:uid('SUB'), studentId:currentUser.studentId, nis:st ? st.nis : currentUser.username, name: currentUser.name, note, link, file: fileObj, submittedAt: new Date().toISOString()};
        t.submissions.push(sub); saveDB(); alert('Tugas dikirim'); renderTaskDetail(taskId);
      });
    }
  }

  // teacher/admin actions: download files & grade
  content.querySelectorAll('.dlFile').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const subId = btn.dataset.id;
      const sub = t.submissions.find(s=>s.id===subId);
      if(!sub || !sub.file || !sub.file.base64) return alert('File tidak tersedia');
      downloadBase64File(sub.file.base64, sub.file.name, sub.file.type);
    });
  });

  content.querySelectorAll('.save-grade').forEach((btn, i)=>{
    btn.addEventListener('click', ()=>{
      const tr = btn.closest('tr');
      const subId = tr.dataset.subid;
      const input = tr.querySelector('.grade-input');
      const val = input.value.trim();
      const num = val === '' ? undefined : (isNaN(Number(val)) ? val : Number(val));
      const sub = t.submissions.find(s=>s.id===subId);
      if(!sub) return alert('Submisi tidak ditemukan');
      sub.score = num;
      sub.gradedBy = currentUser.username;
      sub.gradedAt = new Date().toISOString();
      saveDB();
      alert(`Nilai disimpan untuk ${sub.name}`);
      renderTaskDetail(taskId);
    });
  });
}

/* ---------------- Utility: file -> base64 and download ---------------- */
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result.split(',')[1]); // return base64 string only
    r.onerror = ()=> rej(new Error('read error'));
    r.readAsDataURL(file);
  });
}

function downloadBase64File(base64, filename, mime){
  // convert base64 to blob and download
  const byteChars = atob(base64);
  const byteNumbers = new Array(byteChars.length);
  for (let i = 0; i < byteChars.length; i++) {
    byteNumbers[i] = byteChars.charCodeAt(i);
  }
  const byteArray = new Uint8Array(byteNumbers);
  const blob = new Blob([byteArray], {type: mime || 'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename || 'file';
  a.click(); URL.revokeObjectURL(url);
}

/* ---------------- Data Students per class ---------------- */
function renderDataStudents(){
  if(!['admin','guru'].includes(currentUser.role)) return alert('Akses ditolak');
  content.innerHTML = `<h3>Data Siswa (Per Kelas)</h3><div style="display:flex;gap:8px;align-items:center"><select id="dsClass" class="input"></select><button id="btnRefreshDS" class="btn btn-ghost">Refresh</button></div><div id="dsArea"></div>`;
  const sel = document.getElementById('dsClass'); db.classes.forEach(c=> sel.appendChild(Object.assign(document.createElement('option'),{value:c.id,textContent:c.name})));
  sel.onchange = draw; document.getElementById('btnRefreshDS').onclick = draw;
  draw();

  function draw(){
    const cls = findClassById(sel.value || db.classes[0].id); const area = document.getElementById('dsArea'); area.innerHTML = '';
    if(!cls) return area.innerHTML = '<div class="small">Tidak ada kelas</div>';
    const tbl = document.createElement('div'); tbl.className='card';
    tbl.innerHTML = `<h4>${cls.name} — ${cls.students.length} siswa</h4><table class="table"><thead><tr><th>NIS</th><th>Nama</th><th>Absensi (riwayat)</th><th>Nilai (riwayat)</th><th>Aksi</th></tr></thead><tbody>${cls.students.map(s=>`<tr><td>${s.nis}</td><td>${s.name}</td><td>${(s.attendance||[]).map(a=>`${a.date}:${a.status}`).join('<br>')||'-'}</td><td>${(s.grades||[]).map(g=>`${g.date} • ${g.subject} • ${g.assignment}: ${g.value}`).join('<br>')||'-'}</td><td>${currentUser.role==='admin'?`<button data-sid="${s.id}" data-cid="${cls.id}" class="editStd btn btn-ghost">Edit</button> <button data-sid="${s.id}" data-cid="${cls.id}" class="delStd btn btn-ghost">Hapus</button>`:'-'}</td></tr>`).join('')}</tbody></table>`;
    area.appendChild(tbl);

    area.addEventListener('click',(e)=>{
      if(e.target.classList.contains('editStd')){ const sid = e.target.dataset.sid, cid = e.target.dataset.cid; const cls = findClassById(cid); const s = cls.students.find(x=>x.id===sid); const nn = prompt('Nama baru:', s.name); if(nn){ s.name = nn; saveDB(); draw(); } }
      if(e.target.classList.contains('delStd')){ if(!confirm('Hapus siswa?')) return; const sid = e.target.dataset.sid, cid = e.target.dataset.cid; const cls = findClassById(cid); cls.students = cls.students.filter(x=>x.id!==sid); saveDB(); draw(); refreshKPIs(); }
    });
  }
}

/* ---------------- SPP (per student across classes) ---------------- */
function renderSPP(){
  content.innerHTML = `<h3>SPP (Pembayaran)</h3>
    <div class="small">Cari siswa dari semua kelas — atur status pembayaran dan nominal.</div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px"><input id="sppSearch" class="input" placeholder="Cari NIS atau nama..."/><button id="btnAddSPP" class="btn btn-primary">Tambah Tagihan</button></div>
    <div id="sppArea" style="margin-top:12px"></div>`;
  document.getElementById('sppSearch').addEventListener('input', drawList);
  document.getElementById('btnAddSPP').addEventListener('click', ()=>{
    const nis = prompt('NIS siswa:'); if(!nis) return; const student = findStudentByNIS(nis);
    if(!student) return alert('Siswa tidak ditemukan');
    const month = prompt('Bulan (contoh: 2025-11):')||new Date().toISOString().slice(0,7);
    const amount = prompt('Nominal (Rp):','150000') || '0';
    const id = uid('SPP'); db.spp.push({id, studentId:student.id, nis:student.nis, name:student.name, month, amount: Number(amount), status:'unpaid'}); saveDB(); drawList(); alert('Tagihan ditambahkan');
  });
  drawList();

  function drawList(){
    const q = document.getElementById('sppSearch').value.trim().toLowerCase();
    const area = document.getElementById('sppArea'); area.innerHTML = '';
    const rows = db.spp.filter(s=> !q || s.nis.toLowerCase().includes(q) || s.name.toLowerCase().includes(q) );
    if(rows.length===0) area.innerHTML = '<div class="small">Belum ada tagihan match.</div>';
    else {
      const tbl = document.createElement('div'); tbl.className='card';
      tbl.innerHTML = `<table class="table"><thead><tr><th>NIS</th><th>Nama</th><th>Bulan</th><th>Nominal</th><th>Status</th><th>Aksi</th></tr></thead><tbody>${rows.map(r=>`<tr data-id="${r.id}"><td>${r.nis}</td><td>${r.name}</td><td>${r.month}</td><td>Rp ${r.amount.toLocaleString('id-ID')}</td><td>${r.status}</td><td>${currentUser.role==='admin'?`<button data-id="${r.id}" class="setPaid btn btn-primary">Sudah Bayar</button> <button data-id="${r.id}" class="delSPP btn btn-ghost">Hapus</button>`:'-'}</td></tr>`).join('')}</tbody></table>`;
      area.appendChild(tbl);
      area.addEventListener('click',(e)=>{
        if(e.target.classList.contains('setPaid')){
          const id = e.target.dataset.id; const s = db.spp.find(x=>x.id===id); s.status='paid'; saveDB(); drawList();
        }
        if(e.target.classList.contains('delSPP')){
          if(!confirm('Hapus tagihan?')) return; const id = e.target.dataset.id; db.spp = db.spp.filter(x=>x.id!==id); saveDB(); drawList();
        }
      });
    }
  }
}
function findStudentByNIS(nis){ for(const c of db.classes){ const s = c.students.find(x=>x.nis===nis); if(s) return s; } return null; }

/* ---------------- PPDB ---------------- */
function renderPPDB(){
  if(currentUser.role!=='admin') return alert('Hanya admin');
  content.innerHTML = `<h3>PPDB (Calon)</h3>
    <div class="card">
      <input id="pp_name" class="input" placeholder="Nama calon"/><input id="pp_school" class="input" placeholder="Asal sekolah"/>
      <select id="pp_major" class="input"><option>TKJ</option></select>
      <select id="pp_class" class="input"></select>
      <input id="pp_contact" class="input" placeholder="Kontak/email"/>
      <div class="controls" style="margin-top:8px"><button id="pp_do" class="btn btn-primary">Daftar Calon</button></div>
    </div>
    <div id="ppList" style="margin-top:12px"></div>`;
  const sel = document.getElementById('pp_class'); sel.innerHTML = '';
  db.classes.forEach(c=> sel.appendChild(Object.assign(document.createElement('option'),{value:c.id,textContent:c.name})));
  document.getElementById('pp_do').addEventListener('click', ()=>{
    const name = document.getElementById('pp_name').value.trim(), school = document.getElementById('pp_school').value.trim(), major = document.getElementById('pp_major').value, classId = document.getElementById('pp_class').value, contact = document.getElementById('pp_contact').value.trim();
    if(!name||!school||!contact) return alert('Lengkapi');
    db.applicants.push({id:uid('AP'), name, school, major, classId, contact, appliedAt:new Date().toISOString(), status:'pending'}); saveDB(); alert('Calon siswa tersimpan (pending)'); renderPPDB();
  });
  drawList();
  function drawList(){
    const list = document.getElementById('ppList'); list.innerHTML = '';
    if(db.applicants.length===0) list.innerHTML = '<div class="small">Belum ada calon</div>';
    db.applicants.forEach(ap=>{
      const cls = findClassById(ap.classId);
      const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px';
      d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${ap.name}</strong><div class="small">${ap.school} • ${ap.major} • ${cls?cls.name:'-'}</div><div class="small">${ap.contact}</div></div><div class="controls"><button data-id="${ap.id}" class="approve btn btn-primary">Setujui</button><button data-id="${ap.id}" class="reject btn btn-ghost">Tolak</button></div></div>`;
      list.appendChild(d);
    });
    list.addEventListener('click',(e)=>{
      if(e.target.classList.contains('approve')){
        const id = e.target.dataset.id; const ap = db.applicants.find(x=>x.id===id); ap.status='approved';
        const sid = uid('S'); const cls = findClassById(ap.classId) || db.classes[0]; cls.students.push({id:sid, nis:sid, name:ap.name, attendance:[], grades:[]});
        db.users.push({id:uid('u'), username:sid, name:ap.name, pass:'password', role:'siswa', studentId:sid}); saveDB(); renderPPDB(); alert('Calon disetujui, akun dibuat: '+sid);
      }
      if(e.target.classList.contains('reject')){ const id = e.target.dataset.id; db.applicants = db.applicants.filter(x=>x.id!==id); saveDB(); renderPPDB(); }
    });
  }
}

/* ---------------- All Data (admin) ---------------- */
function renderAllData(){
  if(currentUser.role!=='admin') return alert('Hanya admin');
  content.innerHTML = `<h3>Semua Data</h3><div class="small">Rekap seluruh data — export JSON / Word.</div>
    <div style="margin-top:12px" class="controls"><button id="expJSON" class="btn btn-ghost">Export JSON</button><button id="expWord" class="btn btn-primary">Export Word (.doc)</button></div>
    <div id="allArea" style="margin-top:12px"></div>`;
  const area = document.getElementById('allArea'); area.innerHTML = `<div class="card"><h4>Murid per Kelas</h4>${db.classes.map(c=>`<div style="margin-bottom:6px"><strong>${c.name}</strong><div class="small">${c.students.map(s=>`${s.nis} — ${s.name}`).join('<br>')||'<i>Tidak ada siswa</i>'}</div></div>`).join('')}</div>
    <div class="card" style="margin-top:8px"><h4>Absensi ringkasan</h4><div class="small">${db.classes.map(c=>`${c.name}: ${c.students.reduce((a,s)=>a + s.attendance.length,0)} catatan`).join('<br>')}</div></div>
    <div class="card" style="margin-top:8px"><h4>Tugas</h4><div class="small">${db.tugas.length} tugas tersimpan</div></div>`;
  document.getElementById('expJSON').addEventListener('click', ()=> {
    const blob = new Blob([JSON.stringify(db, null, 2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`squilo_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('expWord').addEventListener('click', ()=> exportWord('Export by admin'));
}

/* Word export */
function exportWord(note){
  let html = '<html><head><meta charset="utf-8"/></head><body>';
  html += `<h1>Squilo Backup</h1><h4>${new Date().toLocaleString()}</h4><h4>Note: ${note||''}</h4>`;
  html += '<h2>Murid per Kelas</h2>';
  db.classes.forEach(c=>{ html += `<h3>${c.name}</h3><ul>` + c.students.map(s=>`<li>${s.nis} — ${s.name}</li>`).join('') + '</ul>'; });
  html += '<h2>Absensi</h2><table border="1" cellpadding="6"><tr><th>Tanggal</th><th>Kelas</th><th>NIS</th><th>Nama</th><th>Status</th></tr>';
  db.classes.forEach(c=> c.students.forEach(s=> s.attendance.forEach(a=> { html += `<tr><td>${a.date}</td><td>${c.name}</td><td>${s.nis}</td><td>${s.name}</td><td>${a.status}</td></tr>` })));
  html += '</table>';
  html += '<h2>Nilai</h2>';
  db.classes.forEach(c=> c.students.forEach(s=> s.grades.forEach(g=> { html += `<div>${c.name} • ${s.nis} • ${s.name} — ${g.date} • ${g.subject} • ${g.assignment}: ${g.value}</div>` })));
  html += '<h2>Tugas & Pengumpulan</h2>';
  db.tugas.forEach(t=> {
    html += `<h3>${t.title} • ${t.deadline||'-'} • Kelas: ${findClassById(t.classId)?.name||'-'}</h3>`;
    if(t.submissions.length===0) html += '<div class="small">Belum ada pengumpulan</div>';
    else t.submissions.forEach(s=> html += `<div>${s.nis} • ${s.name} — ${s.submittedAt} • Nilai: ${s.score !== undefined ? s.score : '-'}</div>`);
  });
  html += '</body></html>';
  const blob = new Blob([html], {type:'application/msword'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`squilo_backup_${new Date().toISOString().slice(0,10)}.doc`; a.click(); URL.revokeObjectURL(url);
}

/* ---------------- Users (admin) ---------------- */
function renderUsers(){
  if(currentUser.role!=='admin') return alert('Hanya admin');
  content.innerHTML = `<h3>Pengguna</h3><div class="controls"><button id="addUser" class="btn btn-primary">Buat Pengguna</button></div><div id="usersArea" class="card" style="margin-top:12px"></div>`;
  draw();
  document.getElementById('addUser').addEventListener('click', ()=>{
    const username = prompt('username:'), name = prompt('nama:'), role = prompt('role (admin/guru/siswa):','guru'), pass = prompt('password:','1234');
    if(!username||!name||!role||!pass) return alert('Lengkapi'); const newUser = {id:uid('u'), username, name, pass, role};
    if(role==='siswa'){ const sid=uid('S'); newUser.studentId = sid; db.classes[0].students.push({id:sid, nis:username, name, attendance:[], grades:[]}); }
    db.users.push(newUser); saveDB(); draw();
  });

  function draw(){
    const area = document.getElementById('usersArea'); area.innerHTML = '';
    const rows = db.users.map(u=>`<tr><td>${u.username}</td><td>${u.name}</td><td>${u.role}</td><td>${u.role!=='admin'?`<button data-id="${u.id}" class="delUser btn btn-ghost">Hapus</button>`:'-'}</td></tr>`).join('');
    area.innerHTML = `<table class="table"><thead><tr><th>Username</th><th>Nama</th><th>Role</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table>`;
    area.addEventListener('click',(e)=> {
      if(e.target.classList.contains('delUser')){ if(!confirm('Hapus pengguna?')) return; db.users = db.users.filter(x=>x.id !== e.target.dataset.id); saveDB(); draw(); }
    });
  }
}

/* ---------------- Change Password ---------------- */
function renderChangePassword(){
  content.innerHTML = `<h3>Ubah Password</h3><div class="card"><input id="oldp" class="input" placeholder="Password lama" type="password"/><input id="newp" class="input" placeholder="Password baru" type="password"/><input id="newp2" class="input" placeholder="Ulangi password" type="password"/><div class="controls" style="margin-top:8px"><button id="savePass" class="btn btn-primary">Simpan</button></div></div>`;
  document.getElementById('savePass').addEventListener('click', ()=>{
    const oldp = document.getElementById('oldp').value, np = document.getElementById('newp').value, np2 = document.getElementById('newp2').value;
    if(!oldp||!np||!np2) return alert('Lengkapi'); if(oldp !== currentUser.pass) return alert('Password lama salah'); if(np !== np2) return alert('Password baru tidak sama');
    const u = db.users.find(x=>x.id===currentUser.id); u.pass = np; currentUser.pass = np; saveDB(); alert('Password berhasil diubah');
  });
}

/* ---------------- Import/Export Admin ---------------- */
btnImport.addEventListener('click', ()=>{
  if(currentUser.role!=='admin') return alert('Hanya admin');
  const f = document.createElement('input'); f.type='file'; f.accept='.json'; f.onchange = e=>{
    const file = e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload = ()=> { try{ const data = JSON.parse(r.result); db = data; saveDB(); alert('Import sukses'); location.reload(); } catch(err){ alert('JSON tidak valid'); } }; r.readAsText(file);
  }; f.click();
});
btnExport.addEventListener('click', ()=>{
  if(currentUser.role!=='admin') return alert('Hanya admin');
  const blob = new Blob([JSON.stringify(db, null, 2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`squilo_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
});
btnExportWord.addEventListener('click', ()=> { if(currentUser.role!=='admin') return alert('Hanya admin'); exportWord('Manual export by admin'); });

/* ---------------- Dark/Light mode (toggle applies full dark variables) ---------------- */
btnToggleMode.addEventListener('click', ()=>{
  document.body.classList.toggle('dark-mode');
});

/* ---------------- Init ---------------- */
(function init(){
  updateTop(); showLoginPanel(); hide(app); populateRegClass();
  // keep db in window for debugging if necessary
  window._squilo_db = db;
  window._saveDB = saveDB;
})();
</script>
</body>
</html>
